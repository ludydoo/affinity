<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var Relation = require(&#39;./../Relation.js&#39;);
var Header = require(&#39;./../Header.js&#39;);
var _ = require(&#39;lodash&#39;);
var debug = require(&#39;./../helpers/debug&#39;);

var Difference = Relation.extend(


    {

<span id='Operators-Difference'>        /**
</span>         * @class Operators.Difference
         * @extends Relation
         * @param {Relation} left The relation from which to remove the tuples
         * @param {Relation} right The relation that will be substracted from the other
         *
         * The Difference operation gives the first relation&#39;s tuples minus those that are in the second relation.
         *
         *     var left = new affinity.Relation([
         *              {a: { type: affinity.Integer}},
         *              {b: { type: affinity.Integer}},
         *              {c: { type: affinity.Integer}}
         *          ],[
         *              [1, 2, 3],
         *              [4, 5, 6],
         *              [7, 8, 9]
         *          ]);

         *     var right = new affinity.Relation([
         *              {a: { type: affinity.Integer}},
         *              {b: { type: affinity.Integer}},
         *              {c: { type: affinity.Integer}}
         *          ], [
         *              [1, 2, 3]
         *          ]);
         *
         *     var rel3 = left.difference(right);
         *
         *     // or
         *
         *     var rel4 = new affinity.Difference(left, right)
         *
         *     // +--------------+--------------+--------------+
         *     // | a : TInteger | b : TInteger | c : TInteger |
         *     // +==============+==============+==============+
         *     // | 4            | 5            | 6            |
         *     // +--------------+--------------+--------------+
         *     // | 7            | 8            | 9            |
         *     // +--------------+--------------+--------------+
         */
        constructor: function (left, right) {

            debug.difference.trace(&#39;#constructor&#39;);

<span id='Operators-Difference-property-args'>            /**
</span>             * @property {Object} args
             */
            this.args = {};

<span id='Operators-Difference-property-left'>            /**
</span>             * @property {Relation} left
             */
            this.args.left = left;

<span id='Operators-Difference-property-right'>            /**
</span>             * @property {Relation} right
             */
            this.args.right = right;

<span id='Operators-Difference-property-relations'>            /**
</span>             * @property {Relation[]} relations
             */
            this.args.relations = [left, right];

<span id='Operators-Difference-property-computed'>            /**
</span>             * @property {Boolean} computed
             */
            this.computed = false;

            // Calls the parent constructor
            Relation.call(this);

        },

        bindEvents: function () {

            debug.difference.trace(&#39;#bindEvents&#39;);

            Difference.__super__.bindEvents.call(this);

            var that = this;

            var left = that.args.left;
            var right = that.args.right;

            // BeforeGetHeader
            this.ee.once(&#39;beforeGetHeader&#39;, function () {

                var leftHeader = left.header();
                var rightHeader = right.header();

                debug.difference.trace(&#39;beforeGetHeader&#39;);

                Header.assertUnionCompatible(leftHeader, rightHeader);

                that.header().copy(leftHeader);

            });


            // BeforeGetBody
            this.ee.once(&#39;beforeGetBody&#39;, function () {

                debug.difference.trace(&#39;beforeGetBody&#39;);

                left.each(function (tuple1) {

                    if (right.index(tuple1) === null) {

                        that.add(tuple1.clone(), false);

                    }

                });

                that.computed = true;

            });

            left.ee.on(&#39;afterAdd&#39;, function(tuple, index){
                that.afterLeftAdd(left, tuple);
            });

            right.ee.on(&#39;afterAdd&#39;, function(tuple, index){
                that.afterRightAdd(left, tuple);
            });

            left.ee.on(&#39;afterRemove&#39;, function(tuple, index){
                that.afterLeftRemove(right, tuple);
            });

            right.ee.on(&#39;afterRemove&#39;, function(tuple, index){
                that.afterRightRemove(right, tuple);
            });

            left.ee.on(&#39;afterUpdate&#39;, function(tuple, attributeName, value, oldValue){
                that.afterLeftUpdate(left, tuple, attributeName, value, oldValue);
            });

            right.ee.on(&#39;afterUpdate&#39;, function(tuple, attributeName, value, oldValue){
                that.afterRightUpdate(right, tuple, attributeName, value, oldValue);
            });

        },

<span id='Operators-Difference-method-afterLeftRemove'>        /**
</span>         * Event triggered when tuples are removed from the left relation
         * @param {Relation} relation
         * @param {Tuple} removedTuple
         */
        afterLeftRemove : function(relation, removedTuple){

            // If the tuple is not present in the right relation,
            // remove it
            if(this.computed &amp;&amp; this.args.right.index(removedTuple) === null){
                this.remove(removedTuple);
            }

        },

<span id='Operators-Difference-method-afterRightRemove'>        /**
</span>         * Event triggered when tuples are removed from the right relation
         * @param {Relation} relation
         * @param {Tuple} removedTuple
         */
        afterRightRemove : function(relation, removedTuple){

            // If the tuple is present in the left relation,
            // add it.
            if(this.computed &amp;&amp; this.args.left.index(removedTuple) !== null){
                this.add(removedTuple.clone());
            }

        },

<span id='Operators-Difference-method-afterLeftAdd'>        /**
</span>         * Event triggered when tuples are added to the left base relation
         * @param {Relation} relation
         * @param {Tuple} addedTuple
         */
        afterLeftAdd : function(relation, addedTuple){

            // If the tuple is not in the right
            // relation, add it.
            if(this.computed &amp;&amp; this.args.right.index(addedTuple) === null){

                this.add(addedTuple.clone());

            }

        },

<span id='Operators-Difference-method-afterRightAdd'>        /**
</span>         * Event triggered when tuples are added to the right base relation
         * @param {Relation} relation
         * @param {Tuple} addedTuple
         */
        afterRightAdd : function(relation, addedTuple){

            // If the tuple is present in the left
            // relation, remove it.
            if(this.computed &amp;&amp; this.args.left.index(addedTuple) !== null){

                this.remove(addedTuple);

            }

        },

<span id='Operators-Difference-method-afterLeftUpdate'>        /**
</span>         * Event triggered when tuples are updated on the left relation
         * @param {Relation}relation
         * @param {Tuple} tuple
         * @param {String} attributeName
         * @param {*} value
         * @param {*} oldValue
         */
        afterLeftUpdate : function(relation, tuple, attributeName, value, oldValue){

            if(this.computed){

                var oldRightIndex, rightIndex, oldTuple;

                oldTuple = tuple.clone();

                oldTuple.attributes[attributeName] = oldValue;

                oldRightIndex = this.args.right.index(oldTuple);
                rightIndex = this.args.right.index(tuple);

                if(oldRightIndex === null &amp;&amp; rightIndex === null){

                    this.find(oldTuple).set(attributeName, value);

                } else if (oldRightIndex === null &amp;&amp; rightIndex !== null){

                    this.remove(oldTuple);

                } else if (oldRightIndex !== null &amp;&amp; rightIndex === null){

                    this.add(tuple.clone());

                }

            }


        },

<span id='Operators-Difference-method-afterRightUpdate'>        /**
</span>         * Event triggered when tuples are updated on the right relation
         * @param {Relation}relation
         * @param {Tuple} tuple
         * @param {String} attributeName
         * @param {*} value
         * @param {*} oldValue
         */
        afterRightUpdate : function(relation, tuple, attributeName, value, oldValue){

            if(this.computed){

                var oldLeftIndex, leftIndex, oldTuple;

                oldTuple = tuple.clone();

                oldTuple.attributes[attributeName] = oldValue;

                oldLeftIndex = this.args.left.index(oldTuple);
                leftIndex = this.args.left.index(tuple);

                if (oldLeftIndex === null &amp;&amp; leftIndex !== null){

                    this.remove(tuple);

                } else if (oldLeftIndex !== null &amp;&amp; leftIndex !== null){

                    this.add(oldTuple);

                    this.remove(tuple);

                } else if (oldLeftIndex !== null &amp;&amp; leftIndex === null){

                    this.add(oldTuple);

                }
            }
        }

    }, {

        type : &#39;Difference&#39;

    });

module.exports = Difference;</pre>
</body>
</html>
